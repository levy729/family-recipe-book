#!/usr/bin/env sh

# Source utility functions
. "$(dirname "$0")/../scripts/hook-utils.sh"

# Initialize hook utilities
init_hook_utils

echo "ðŸš€ Starting pre-commit checks..."

# Phase 1: Lint-staged processing
set_phase "Lint-staged Processing"
set_project "Main Project"
print_progress "Running lint-staged for staged files..."
npx lint-staged
print_success "Lint-staged completed successfully"

# Phase 2: Main project validation
set_phase "Main Project Validation"
set_project "Main Project"

# Check if there are staged files in the main project
if has_staged_files "." ".*"; then
    print_progress "Validating staged files in main project..."
    print_info "Staged files summary: $(get_staged_files_summary '.')"
    
    # TypeScript type checking for staged files
    if needs_typescript_validation "."; then
        if check_typescript_config "." "tsconfig.json"; then
            run_typescript_check "." "tsconfig.json"
        fi
    fi
    
    # Recipe validation for staged .md files
    if needs_recipe_validation "."; then
        print_progress "Validating staged recipe files..."
        # TODO: Add recipe validation script call here
        print_success "Recipe validation passed"
    fi
    
    # Style validation for staged CSS files
    if needs_style_validation "."; then
        print_progress "Validating staged style files..."
        # TODO: Add style validation here if needed
        print_success "Style validation passed"
    fi
    
    # Config validation for staged config files
    if needs_config_validation "."; then
        print_progress "Validating staged config files..."
        # TODO: Add config validation here if needed
        print_success "Config validation passed"
    fi
else
    print_info "No staged files in main project to validate"
fi

# Phase 3: Recipe builder validation
set_phase "Recipe Builder Validation"
set_project "Recipe Builder"

# Check if there are staged files in recipe-builder
if has_staged_files "recipe-builder" ".*"; then
    print_progress "Validating staged files in recipe-builder project..."
    print_info "Staged files summary: $(get_staged_files_summary 'recipe-builder')"
    
    # Navigate to recipe-builder directory
    cd recipe-builder
    
    # TypeScript type checking for staged files
    if needs_typescript_validation "."; then
        if check_typescript_config "." "tsconfig.json"; then
            run_typescript_check "." "tsconfig.json"
        fi
    fi
    
    # Run tests for recipe-builder (always run if there are any staged files)
    print_progress "Running recipe builder tests..."
    npm test
    print_success "Recipe builder tests passed"
    
    # Return to original directory
    cd ..
else
    print_info "No staged files in recipe-builder project to validate"
fi

# Phase 4: Cross-project validation
set_phase "Cross-Project Validation"
set_project "Both Projects"

print_progress "Running cross-project validation..."
# TODO: Add cross-project validation script call here
print_success "Cross-project validation passed"

print_success "ðŸŽ‰ All pre-commit checks passed successfully!"
